<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.samgyeobsal.mapper.MakerMapper">

    <select id="findFundingMakerByFundingId" resultType="fundingMaker">
        select
            f.fid, f.fstore_name, f.ftitle, f.fsummary,f.fstory,f.fdate, f.fstatus,
            f.memail, f.ctid, ct.ctname, f.fthumb, f.cid, f.tid,  tmp.hasProduct, tmp2.hasImg
        from funding f
        left join category ct on (ct.ctid = f.ctid)
        inner join (
            select funding.fid, decode(count(*),0,0,1) hasProduct
            from funding
                 left join funding_product on (funding.fid = funding_product.fid)
            group by funding.fid
        ) tmp on (f.fid = tmp.fid)
        inner join (
            select funding.fid, decode(count(*),0,0,1) hasImg
            from funding
                     left join funding_img on (funding.fid = funding_img.fid)
            group by funding.fid
        ) tmp2 on (f.fid = tmp2.fid)
        where f.fid = #{fundingId}
    </select>

    <update id="updateFundingBaseInfo">
        update funding
        set fstore_name = #{fstore_name},
            fthumb = #{fthumb},
            ctid = #{ctid},
            cid = #{cid}
        where fid = #{fid}
    </update>

    <select id="findFundingImgListByFundingId" resultType="fundingImg">
        select fi.fiid, fi.fiurl, fi.fid
        from funding_img fi
        where fi.fid = #{fundingId}
    </select>

    <update id="updateFundingStory" >
        update funding
        set ftitle = #{ftitle},
            fsummary = #{fsummary},
            fstory = #{fstory}
        where fid = #{fid}
    </update>

    <delete id="deleteFundingImgsByFundingId">
        delete from funding_img
        where fid = #{fundingId}
    </delete>

    <update id="insertFundingImgs" parameterType="java.util.List">
        <foreach open="INSERT ALL" close="SELECT 1 FROM DUAL"
                 index="index" collection="imgs" item="fundingImg" separator=" ">
        into funding_img (fid, fiid, fiurl)
        values (#{fundingImg.fid}, #{fundingImg.fiid}, #{fundingImg.fiurl})
        </foreach>
    </update>
</mapper>